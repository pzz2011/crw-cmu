
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Airboats Visualization</title>
	<style type="text/css">
    	#slider { margin: 10px; }
		/* css for timepicker */
		.ui-timepicker-div .ui-widget-header { margin-bottom: 8px; }
		.ui-timepicker-div dl { text-align: left; }
		.ui-timepicker-div dl dt { height: 25px; margin-bottom: -25px; }
		.ui-timepicker-div dl dd { margin: 0 10px 10px 65px; }
		.ui-timepicker-div td { font-size: 90%; }
		.ui-tpicker-grid-label { background: none; border: none; margin: 0; padding: 0; }
		.ui-combobox { position: relative; display: inline-block; }
		.ui-combobox-input { margin: 0; padding: 0.3em; }
 	</style>

  	<script src="UTMConvertor.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
  	<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
    <script src="jquery.csv.js"></script>
    <script type="text/javascript" src="jquery-ui-timepicker-addon.js"></script>

    
  
   	<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
 	<link rel="stylesheet" media="all" type="text/css" href="http://code.jquery.com/ui/1.8.21/themes/ui-lightness/jquery-ui.css" />
	
  <script>
		/* Combo box Stuff */
		(function( $ ) {
		$.widget( "ui.combobox", {
			_create: function() {
				var input,
					self = this,
					select = this.element.hide(),
					selected = select.children( ":selected" ),
					value = selected.val() ? selected.text() : "",
					wrapper = this.wrapper = $( "<span>" )
						.addClass( "ui-combobox" )
						.insertAfter( select );

				input = $( "<input>" )
					.appendTo( wrapper )
					.val( value )
					.addClass( "ui-state-default ui-combobox-input" )
					.autocomplete({
						delay: 0,
						minLength: 0,
						source: function( request, response ) {
							var matcher = new RegExp( $.ui.autocomplete.escapeRegex(request.term), "i" );
							response( select.children( "option" ).map(function() {
								var text = $( this ).text();
								if ( this.value && ( !request.term || matcher.test(text) ) )
									return {
										label: text.replace(
											new RegExp(
												"(?![^&;]+;)(?!<[^<>]*)(" +
												$.ui.autocomplete.escapeRegex(request.term) +
												")(?![^<>]*>)(?![^&;]+;)", "gi"
											), "<strong>$1</strong>" ),
										value: text,
										option: this
									};
							}) );
						},
						select: function( event, ui ) {
							ui.item.option.selected = true;
							self._trigger( "selected", event, {
								item: ui.item.option
							});
						},
						change: function( event, ui ) {
							if ( !ui.item ) {
								var matcher = new RegExp( "^" + $.ui.autocomplete.escapeRegex( $(this).val() ) + "$", "i" ),
									valid = false;
								select.children( "option" ).each(function() {
									if ( $( this ).text().match( matcher ) ) {
										this.selected = valid = true;
										return false;
									}
								});
								if ( !valid ) {
									// remove invalid value, as it didn't match anything
									$( this ).val( "" );
									select.val( "" );
									input.data( "autocomplete" ).term = "";
									return false;
								}
							}
						}
					})
					.addClass( "ui-widget ui-widget-content ui-corner-left" );

					input.data( "autocomplete" )._renderItem = function( ul, item ) {
						return $( "<li></li>" )
							.data( "item.autocomplete", item )
							.append( "<a>" + item.label + "</a>" )
							.appendTo( ul );
					};

					$( "<a>" )
						.attr( "tabIndex", -1 )
						.attr( "title", "Show All Items" )
						.appendTo( wrapper )
						.button({
							icons: {
								primary: "ui-icon-triangle-1-s"
							},
							text: false
						})
						.removeClass( "ui-corner-all" )
						.addClass( "ui-corner-right ui-combobox-toggle" )
						.click(function() {
							// close if already visible
							if ( input.autocomplete( "widget" ).is( ":visible" ) ) {
								input.autocomplete( "close" );
								return;
							}

							// work around a bug (likely same cause as #5265)
							$( this ).blur();

							// pass empty string as value to search for, displaying all results
							input.autocomplete( "search", "" );
							input.focus();
						});
				},

				destroy: function() {
					this.wrapper.remove();
					this.element.show();
					$.Widget.prototype.destroy.call( this );
				}
			});
		})( jQuery );
		
		/* Initializing UI elements */
		$(function() {
			$("#slider").slider({
				value: 10,
				min: 5,
				max: 30,
   				slide: function(event, ui) {heatmap.setOptions({radius:ui.value}) }
			});
			$("#controls").accordion({ autoHeight: false});
			$("#datepickerStart").datetimepicker({ dateFormat: "yy-mm-dd", showSecond: true, timeFormat: 'hh:mm:ss', showButtonPanel: false });
			$("#datepickerEnd").datetimepicker({ dateFormat: "yy-mm-dd", showSecond: true, timeFormat: 'hh:mm:ss', showButtonPanel: false });
			$("#sourceSelector").combobox();

			var $el = $("#sourceSelector");
			$el.empty(); // remove old options
			var newOptions = getAllFeeds();
			for(i=0; i<newOptions.length; i++)
			  $el.append($("<option></option>").attr("value", newOptions[i].value).text(newOptions[i].key));
			
		});
  </script>
  

    <script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?sensor=false&libraries=visualization"></script>
    <script type="text/javascript">
      var map, pointarray, heatmap;

      var heatMapData = [];
      
	  /* Initializing HeatMap */
      function initialize() {
        var myOptions = {
          zoom: 19,
          center: new google.maps.LatLng(39.49082204234965, -75.78827556766221), //Panther Hollow Coordinates : (40.436847,-79.948551)
          mapTypeId: google.maps.MapTypeId.SATELLITE
        };

        map = new google.maps.Map(document.getElementById("map_canvas"),
            myOptions);

        pointArray = new google.maps.MVCArray(heatMapData);

        heatmap = new google.maps.visualization.HeatmapLayer({
          data: pointArray,
          
        });

        heatmap.setMap(map);
        heatmap.setOptions({radius:6});
        
   		//alert(ToLL(4371542.482658964,432215.51757169154,18).lat + "   " + ToLL(4371542.482658964,432215.51757169154,18).lon);
      }
      
      /* Function to get a list of feeds from cosm
       * This function gets all the feeds of a certain user on cosm, in this case 'crwcmu'	
       */
      function getAllFeeds() {
      	// Requesting list of feeds in json format
      	var request = new XMLHttpRequest();
			request.open("GET", "http://api.cosm.com/v2/feeds?per_page=1000&user=crwcmu&content=summary", false);
			request.setRequestHeader("X-ApiKey", "R5USeoIXogxwJxP3L9wZjJo6imySAKw0VGtpZExrNHJyQT0g");
			request.send(null);
		
		//Parsing the json result string
		var feeds = eval('(' + request.responseText + ')');
		var sources = [];
		for(i=0; i<feeds.results.length; i++)
			sources.push({key:feeds.results[i].title, value:feeds.results[i].id});
		return sources;
			
      }
      
      /*Function to check if a given year is a leap year*/
      function isLeap(year) {
      	if(year%400 == 0)
      		return true;
      	else if( year%100 == 0)
      		return false;
      	else if( year%4 == 0)
      		return true;
      	else
      		return false;
      }
      
      /* Function to add 6 hours to the timeStamp passed in.
       * This function is required as one cannot make API requests on cosm which are longer than 6 hours(If the granuality of the data requested is highest). Thus this function enables us to request data in chunks of 6 hours
       */
      function addHours(timeStamp) {
      	var y, m, d, time;
      	
      	// Extract Year, Month, Day and Hour
      	y = parseInt(timeStamp.substr(0,4), 10);
      	m = parseInt(timeStamp.substr(5,2), 10);
      	d = parseInt(timeStamp.substr(8,2), 10);
      	h = parseInt(timeStamp.substr(11,2), 10);
      	time = timeStamp.substr(13);
      	
      	// Add 6 Hours and check if the day, month and year have changed as a result of this.
      	h += 6;
      	if( h >=24 )
      	{
      		h -= 24;
      		d += 1;
      		
      		if(d == 32)
      		{
      			d = 1;
      			m++;
      		}
      		else if(d == 31 && (m == 2 || m == 4 || m == 6 || m == 9 || m == 11))
      		{
      			d = 1;
      			m++;
      		}
      		else if(d == 29 && m == 2 && !isLeap(y))
      		{
      			d = 1;
      			m++;
      		}
      		
      		if( m > 12)
      		{
      			m = 1;
      			y++;
      		}
      	}
      	
      	// Format the new timestamp
      	var result = y + "-";
      	if( m < 10)
      		result += "0";
      	result += m + "-";
      	if( d < 10)
      		result += "0";
      	result += d + "T";
      	if( h < 10)
      		result += "0";
      	result += h + time;
      	
      	return result;
      }
      
      /* Function to compare two timeStamps.
       * This will enable us to keep fetching data until we have reached at the end of the requested time period
       */
      function compareDates(date1, date2) {
      		var y1, m1, d1, h1, mi1, s1;
      		
      		// Extract individual elements for comparison
      		y1 = date1.substr(0,4);
      		m1 = date1.substr(5,2);
      		d1 = date1.substr(8,2);
      		h1 = date1.substr(11,2);
      		mi1 = date1.substr(14,2);
      		s1 = date1.substr(17,2);
      		
      		var y2, m2, d2, h2, mi2, s2;
      		y2 = date2.substr(0,4);
      		m2 = date2.substr(5,2);
      		d2 = date2.substr(8,2);
      		h2 = date2.substr(11,2);
      		mi2 = date2.substr(14,2);
      		s2 = date2.substr(17,2);
      		
      		// Compare element by element
      		if(parseInt(y1, 10) < parseInt(y2, 10))
      			return -1;
      		else if(parseInt(y1, 10) > parseInt(y2, 10))
      			return 1;
      		else
      		{
      			if(parseInt(m1, 10) < parseInt(m2, 10))
      				return -1;
      			else if(parseInt(m1, 10) > parseInt(m2, 10))
      				return 1;
      			else
      			{
      				if(parseInt(d1, 10) < parseInt(d2, 10))
      					return -1;
      				else if(parseInt(d1, 10) > parseInt(d2, 10))
      					return 1;
      				else
      				{
      					if(parseInt(h1, 10) < parseInt(h2, 10))
      						return -1;
      					else if(parseInt(h1, 10) > parseInt(h2, 10))
      						return 1;
      					else
      					{
      						if(parseInt(mi1, 10) < parseInt(mi2, 10))
      							return -1;
      						else if(parseInt(mi1, 10) > parseInt(mi2, 10))
      							return 1;
      						else
      						{
      							if(parseInt(s1, 10) < parseInt(s2, 10))
      								return -1;
      							else if(parseInt(s1, 10) > parseInt(s2, 10))
      								return 1;
      							else
      								return 0;
      						}
      					}
      				}
      			}
      		}
      }
      
      /* Function to make the actual API requests and create the heat map
      */
      function getData() {
      	
      	// Get all the request parameters(date, type, source etc)
      	var feed = $("#sourceSelector").val();
        var debugBox = document.getElementById("debugInfo");
        
        var intervalStart = $.datepicker.formatDate('yy-mm-dd', $("#datepickerStart").datetimepicker("getDate"));
        var intervalEnd = $.datepicker.formatDate('yy-mm-dd', $("#datepickerEnd").datetimepicker("getDate"));
        
        var startTime = $('#datepickerStart').datetimepicker('getDate') + "";
        var endTime = $('#datepickerEnd').datetimepicker('getDate') + "";
        intervalStart += "T" + startTime.substr(16,8);
        intervalEnd += "T" + endTime.substr(16,8);
                             
        intervalStart += ".000000Z";
        intervalEnd   += ".000000Z";
        
        debugBox.value = "Start Time: " + intervalStart + "\nEnd Time: " + intervalEnd; 
        		
		var x, y, temp, lastValue=500, lastTime = intervalStart;
		
		debugBox.value += "\n\nRequested timeStamp: " + lastTime;
		
		var allData = [];
		var allLat = [];
		var allLon = [];
		var min = 100000;
		var max = -100000;
	
		var dataType = $("input:checked[name=dataType]").val();
		while(compareDates(lastTime, intervalEnd) < 0)
		{
			// Request Cosm for the data
			var request = new XMLHttpRequest();
			request.open("GET", "https://api.cosm.com/v2/feeds/" + feed + ".csv?datastreams=x,y," + dataType + "&start="+ lastTime +"&duration=6hours&interval=30&per_page=1000", false);
			request.setRequestHeader("X-ApiKey", "R5USeoIXogxwJxP3L9wZjJo6imySAKw0VGtpZExrNHJyQT0g");
			request.send(null);
			
			// Last time is set to 6 hours further(in case their was no data in the time period request above
			lastTime = addHours(lastTime);
			
			// Parse the data received
			boatData = $.csv2Array(request.responseText);
			
			for(i=0; i<boatData.length; i++) {
				// Every line of data can correspond to either (i) actual data (ii) X position or (iii) Y position
				if(boatData[i][0] == dataType)
				{
					temp = boatData[i][2];
				}
				else if(boatData[i][0] == "x")
				{
					x = boatData[i][2];
				}
				else if(boatData[i][0] == "y")
				{
					debugBox.value += "\n" + temp;
					y = boatData[i][2];
					
					// Convert UTM to Lat/Lon
					var res = ToLL(y,x,18);
					
					// Store all data in an array and set min/max so that data can be normalized later
					allData.push(temp);
					allLat.push(res.lat);
					allLon.push(res.lon);
					if(temp < min)
						min = temp;
					if(temp > max)
						max = temp;
					
					lastValue = boatData[i][2];
					lastTime = boatData[i][1];
				}
			}
			debugBox.value += "\nRequested timeStamp: " + lastTime;
		}
		debugBox.value += "\nTotal Number of elements fetched: " + allData.length;
		
		debugBox.value += "\n\nActual data values that are plotted(after normalization):";
		/*Normalizing the Data(Because generally the data points are very close to each other)*/
		var diff = max - min;
		for(var i=0; i<allData.length; i++) {
			var value = ((allData[i]-min)/diff*100);
			debugBox.value += "\n" + value;
			heatMapData.push({location: new google.maps.LatLng(allLat[i], allLon[i]), weight: value});
		}
		
		heatmap.setMap(map);
      }
      

    </script>
  </head>


  
  <body onload="initialize()" style="font-size:65.5%;" bgcolor="gray">
	<style type="text/css">
	#content {
		width:1100px;
		margin:0 auto;
	}
	#map_canvas {
		float:left;
		margin-left:10px;
	}
	#controls {
		float:right;
		margin-right:10px;
		width:270px;
	}
	</style>
	<div id="content">
    	<div id="map_canvas" style="height: 600px; width: 800px;"></div>
    	<div id="controls" style="width: 270px;">
    		<h3><a href="#">Select Source</a></h3>
    		<div>
	    		<select id="sourceSelector">
	    			<option value="">Select one...</option>
					<option value="ActionScript">ActionScript</option>
	    		</select>
	    	</div>
    		<h3><a href="#">Start Date and Time</a></h3>
    		<div id="datepickerStart"></div>
    		<h3><a href="#">End Date and Time</a></h3>
    		<div id="datepickerEnd"></div>
    		<h3><a href="#">Get the Data!</a></h3>
			<div>
				<form>
					<p><b>Type of Data:</b></p>
					<input type="radio" name="dataType" value="temperature" checked>Temperature<br>
					<input type="radio" name="dataType" value="conductivity">Conductivity<br>
				</form>

				<button onclick="getData()">Retrieve Data</button>
				<p><b>Adjust results: </b></p>
				<div id="slider"></div>
			</div>
			<h3><a href="#">Debug Information</a></h3>
			<textarea id="debugInfo" rows="25" style="width: 218px;"></textarea>
      </div>
     </div>
	
-	

  </body>
</html>

